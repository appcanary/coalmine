require 'test_helper'
class VulnerabilityManagerTest < ActiveSupport::TestCase
  self.use_transactional_fixtures = false

  after :each do
    DatabaseCleaner.clean
  end

  test "upon new vuln, should update affected packages" do
    pkg_name = "fakemctest"
    10.times do |i|
      FactoryGirl.create(:ruby_package,
                         :name => pkg_name,
                         :version => "1.0.#{i}")
    end

    assert_equal 10, Package.count
    assert_equal 0, VulnerablePackage.count

    vuln, error = VulnerabilityManager.new.create(:package_names => [pkg_name],
                                                  :package_platform => Platforms::Ruby,
                                                  :patched_versions => {pkg_name => "> 1.0.4"})

    assert_equal 1, Vulnerability.count
    assert_equal 5, vuln.packages.count

    FactoryGirl.create(:ruby_vulnerability)

    assert_equal 2, Vulnerability.count
    assert_equal 5, VulnerablePackage.count
  end

  
  test "handle updates to existing vulnerabilities" do
    pkg_name = "fakemctest"
  
    10.times do |i|
      FactoryGirl.create(:ruby_package,
                         :name => pkg_name,
                         :version => "1.0.#{i}")

    end

    assert_equal 10, Package.count
    assert_equal 0, VulnerablePackage.count


    vuln, error = VulnerabilityManager.new.create(:package_names => [pkg_name],
                                                  :package_platform => Platforms::Ruby,
                                                  :patched_versions => {pkg_name => "> 1.0.1"})

    assert_equal 2, VulnerablePackage.count

    # but actually turns out the bug was more severe than we first thought!!

    updated_vuln, error = VulnerabilityManager.new.update(vuln.id, :patched_versions => {pkg_name => "> 1.0.4"})

    assert updated_vuln.is_a? Vulnerability
    assert_equal updated_vuln.id, vuln.id
    assert_equal 5, VulnerablePackage.count
    assert_equal 1, VulnerabilityArchive.count

    # however after much research and investigation, 
    # someone made a mistake and the vuln versions are much smaller!

    VulnerabilityManager.new.update(vuln.id, :patched_versions => {pkg_name => "> 1.0.0"})
    assert_equal 1, VulnerablePackage.count
    assert_equal 2, VulnerabilityArchive.count
  end


end
