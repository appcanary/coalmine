class VulnerabilityMakerTest < ActiveSupport::TestCase
  self.use_transactional_fixtures = false

  after :each do
    DatabaseCleaner.clean
  end

test "update_affecting_vulnerabilities" do
    v1, v2, _ = FactoryGirl.create_list(:ruby_vulnerability, 5)

    v1.patched_versions = ["> 1.0.1"]
    v1.save

    p1 = FactoryGirl.create(:ruby_package, 
                            :name => v1.package_name,
                            :version => "1.0.0")


    assert_equal 0, VulnerablePackage.count
    assert_equal 1, Package.count
    ActiveRecord::Base.transaction do
      VulnerabilityMaker.new.add_package_to_affecting_vulnerabilities!(Vulnerability.all, p1)
    end

    v1.reload
    assert_equal 1, VulnerablePackage.count
    assert v1.packages.include?(p1)
  end
end
