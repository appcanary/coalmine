class VulnerabilityManager < ServiceManager
  def create(proto_vuln)
    vuln = Vulnerability.new(proto_vuln)

    begin
      vuln.transaction do
        vuln.save!
        assign_dependencies!(vuln)
        update_affected_packages!(vuln)
      end
    rescue ActiveRecord::RecordInvalid => e
      return Result.new(vuln, e)
    end

    return Result.new(vuln)
  end

  def update(vuln_id, attr)
    vuln = Vulnerability.find(vuln_id)

    begin
      vuln.transaction do
        vuln.update_attributes!(attr)
        assign_dependencies!(vuln)
        update_affected_packages!(vuln)
      end
    rescue ActiveRecord::RecordInvalid => e
      return Result.new(vuln, e)
    end

    return Result.new(vuln)
  end

  def assign_dependencies!(vuln)
    vuln_deps = vuln.package_names.map do |name|
      hsh = vuln_dep_attr(name, vuln)        
      VulnerableDependency.new(hsh)
    end

    vuln.vulnerable_dependencies = vuln_deps
  end

  def vuln_dep_attr(name, vuln)
    {:package_platform => vuln.package_platform,
     :package_name => name,
     :affected_arches => vuln.affected_arches,
     :affected_releases => vuln.affected_releases,
     :patched_versions => vuln.patched_versions_for(name),
     :unaffected_versions => vuln.unaffected_versions_for(name)}
  end


  def update_affected_packages!(vuln)
    concerned_packages = vuln.concerned_packages
    affected_packages = concerned_packages.select do |package|
      vuln.affects?(package)
    end

    vuln.packages = affected_packages

    ReportMaker.new.on_vulnerability_change(vuln.id)

    vuln
  end
end
