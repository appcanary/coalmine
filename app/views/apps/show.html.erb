<%= render :partial => "shared/heading" %>

<div class="app">
  <ul class="nav nav-tabs">
    <li class="active" role="presentation">
      <a href="#vuln"  data-toggle="tab">
        <% if @bundle.vuln_packages.empty? %>
          <span class="fa fa-check-circle okay"></span>
        <% else %>
          <span class="fa fa-exclamation-triangle warn"></span>
          vulnerable packages
        <% end %>
      </a>
    </li>
    <li role="presentation">
      <a href="#allpackages" data-toggle="tab">
        all packages
      </a>
    </li>
    <%= link_to "Export to CSV", server_path(@server, format: "csv"), class: "btn btn-default" %>
  </ul>


  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active">
      <table id="vulnerabilities_table" class="table">

        <% if @bundle.vuln_packages.empty? %>
          <tr>
            <td class="empty_message">No vulnerable packages found for this app!</td>
          </tr>
        <% else %>
          <thead>
            <th>package name</th>
            <th>vulnerabilities</th>
            <th>current version</th>
            <th>upgrade to</th>
            <th></th>
          </thead>

          <% @bundle.vuln_packages.each do |package| %>

            <tr>
              <td class="col-md-3">
                <span class="mono"><%= package.name %></span>
              </td>
             
              <td class="vulnerabilities col-md-5">
                <ul>
                  <% package.vulnerable_dependencies.each do |vuln| %>
                    <li class="vulnerability">
                      <p><%= link_to vuln.vulnerability_title, vuln_path(vuln.vulnerability) %></p>

                    </li>
                  <% end %>
                </ul>

              </td>

               <td>
                <code><%= package.version %></code>
              </td>

              <td>
                <p class="upgrade_to"><%= versions_in_english(package.upgrade_to) %></p>
              </td>
              <td>
                <%= form_tag ignore_vuln_monitors_path(package.id), method: :post do %>
                  <%= hidden_field_tag :package_id, package.id %>

                  <%= submit_tag "Mark Ignored", :class => "btn btn-danger" %>
                <% end %>
              </td>

            </tr>


            
          <% end %>
        <% end %>
      </table>
    </div>

    <div id="allpackages" role="tabpanel" class="tab-pane">
      <table id="all_packages" class="artifacts all">
        <% if @packages.empty? %>
          <tr>
            <td class="empty_message">
              No packages found for this app!
            </td>
          </tr>
        <% else %>
          <tr>
            <th>name</th>
            <th>source name</th>
            <th>kind</th>
            <th>version</th>
          </tr>
          <% @packages.each do |package| %>
            <tr class="package">
              <td class="name"><%= package.name %></td>
              <td class="name"><%= package.source_name %></td>
              <td class="kind"><%= package.platform %></td>
              <td class="version"><code><%= package.version %></code></td>
            </tr>
          <% end %>
        <% end %>
      </table>
    </div>
  </div>
</div>
