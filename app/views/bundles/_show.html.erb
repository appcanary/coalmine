<div class="bundle-packages">
  <ul class="nav nav-tabs">
    <li class="active" role="presentation">
      <a href="#vulnerable-packages-tab"  data-toggle="tab">
        <% if @bundlepres.vulnerable? %>
          <span class="fa fa-exclamation-triangle warn"></span>
          vulnerable packages
        <% else %>
          <span class="fa fa-check-circle okay"></span>
        <% end %>
      </a>
    </li>

    <% if @bundlepres.ignored_package_logs.any? %>
      <li role="presentation">
        <a href="#ignored-packages-tab" data-toggle="tab">
          ignored (<%=@bundlepres.ignored_package_logs.count%>)
        </a>
      </li>
    <% end %>


    <li role="presentation">
      <a href="#all-packages-tab" data-toggle="tab">
        all packages
      </a>
    </li>

    <% if @server %>
      <%= link_to "Export to CSV", server_path(@server, format: "csv"), class: "btn btn-default" %>
    <% end %>
  </ul>


  <div class="tab-content">
    <div id="vulnerable-packages-tab" role="tabpanel" class="tab-pane active">
      <table id="vulnerable-packages" class="table packages">
        <% if @bundlepres.vuln_packages.empty? %>
          <tr>
            <td class="empty_message">No vulnerable packages found for this app!</td>
          </tr>
        <% else %>
          <thead>
            <th>package name</th>
            <th>current version</th>
            <th>upgrade to</th>
            <th>priority</th>
            <th>vulnerability</th>
            <th></th>
          </thead>

          <% @bundlepres.vuln_packages.each do |package| %>
            <% vulns = package.vulnerabilities.sort_by(&:criticality_ordinal) %>
            
            <% rowspan = vulns.count <= 5 ? vulns.count  :  6 %>
            <tr>
              <td class="package-name col-md-3" rowspan="<%= rowspan %>">
                <%= package.name %>
              </td>
              <td class="package-version" rowspan="<%= rowspan %>">
                <code><%= package.version %></code>
              </td>
              <td class="package-upgrade-to" rowspan="<%= rowspan %>">
                <p class="upgrade_to"><%= versions_in_english(package.upgrade_to) %></p>
              </td>
              <td>
                <%= vulns.first.criticality %>
              </td>
              <td class="col-md-4">
                <%= link_to vulns.first.title, vuln_path(vulns.first) %>
              </td>

              <td rowspan="<%= rowspan %>">
                <%#= render :partial => "bundles/package_resolution_modal", :locals => { :package => package } %>
                <% if vulns.count == 1 %>
                  <%= eui_button "Mark resolved", :type => "eui-button-small-warning", data_toggle: "modal", data_target: "#modal-#{package.id}", aria_haspopup: "true", aria_expanded: false %>
                <% else %>
                  <%= eui_button "Mark all resolved", :type => "eui-button-small-warning", data_toggle: "modal", data_target: "#modal-#{package.id}", aria_haspopup: "true", aria_expanded: false %>
                <% end %>
              </td>
            </tr>
            <% vulns[1..4].each do |v| %>
              <tr>
                <td>
                  <%= v.criticality %>
                </td>
                <td class="col-md-4">
                  <%= link_to v.title, vuln_path(v) %>
                </td>
            <% end %>
            <% if vulns.count > 5 %>
            <tr>
              <td>
              </td>
              <td>
                see more
              </td>
            </tr>
<% end %>
          <% end %>
        <% end %>
      </table>
    </div>

    <% if @bundlepres.ignored_package_logs.any? %>
      <div id="ignored-packages-tab" role="tabpanel" class="tab-pane">
        <table id="ignored-packages" class="table packages">
          <thead>
            <th>
              user
            </th>
            <th>
              package name
            </th>
            <th>
              version
            </th>
            <th>
              vulnerabilities
            </th>
            <th>
              note
            </th>

            <th>
            </th>
          </thead>

          <% @bundlepres.ignored_package_logs.each do |ip| %>
            <tr>
              <td>
                <%= ip.user.email %>
              </td>

              <td class="package-name">
                <%= ip.package.name %>
              </td>
              <td class="package-version">
                <code><%= ip.package.version %></code>
              </td>

              <td class="">
                <%= ip.vuln_count %>
              </td>

              <td class="col-md-3">
                <%= ip.note %>
              </td>



              <td>
                <%= form_for LogResolution.new, url: unresolve_vuln_monitors_path(ip.package_id), method: :delete do |f| %>
                  <%= f.hidden_field :package_id, value: ip.package_id %>
                  <%= f.submit "Remove", class: "btn btn-small btn-default", :data => {:confirm => "Are you sure? This may trigger new notifications."} %>
                <% end %>
              </td>
            </tr>
          <% end %>

        </table>
      </div>
    <% end %>

    <div id="all-packages-tab" role="tabpanel" class="tab-pane">
      <table id="all-packages" class="table packages">
        <% if !@bundlepres.all_packages.any? %>
          <tr>
            <td class="empty_message">
              No packages found for this app!
            </td>
          </tr>
        <% else %>
          <thead>
            <th>kind</th>
            <th>platform</th>
            <th>name</th>
            <th>source name</th>
            <th>version</th>
          </thead>
          <% @bundlepres.all_packages.each do |package| %>
            <tr class="package">
              <td class="platform"><%= package.platform %></td>
              <td class="release"><%= package.release%></td>
              <td class="package-name"><%= package.name %></td>
              <td class="package-name"><%= package.source_name %></td>
              <td class="package-version--neutral"><code><%= package.version %></code></td>
            </tr>
          <% end %>
        <% end %>
      </table>
    </div>
  </div>
</div>
