# == Schema Information
#
# Table name: vulnerabilities
#
#  id                  :integer          not null, primary key
#  package_name        :string           not null
#  package_platform    :string           not null
#  title               :string
#  reported_at         :datetime
#  description         :text
#  criticality         :string
#  patched_versions    :text             default("{}"), is an Array
#  unaffected_versions :text             default("{}"), is an Array
#  cve_id              :string
#  osvdb_id            :string
#  usn_id              :string
#  dsa_id              :string
#  rhsa_id             :string
#  cesa_id             :string
#  source              :string
#  created_at          :datetime         not null
#  updated_at          :datetime         not null
#  valid_at            :datetime         not null
#  expired_at          :datetime         default("infinity"), not null
#

class Vulnerability < ActiveRecord::Base
  has_many :vulnerable_packages
  has_many :packages, :through => :vulnerable_packages

  belongs_to :advisory

  delegate :title, :to => :advisory

  def affects?(package)
    concerns?(package) &&
      (package.affected?(unaffected_versions) ||
       package.needs_patch?(patched_versions))
  end

  def concerns?(package)
    (package.platform == self.package_platform) && 
      package.same_name?(self.package_name)
  end

  def concerned_packages()
    if self.package_platform == Platforms::Debian
      Package.where(:source_name => self.package_name,
                    :platform => self.package_platform)

    else
      Package.where(:name => self.package_name,
                    :platform => self.package_platform)
    end
  end

end
