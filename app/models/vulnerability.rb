class Vulnerability < ApiBase
  
  delegate :name, :to => :artifact_first, :prefix => true
  delegate :kind, :to => :artifact_first
  delegate :kind_pretty, :to => :artifact_first

  def self.find(id)
    resp = CanaryClient.new.get("vulnerabilities/#{id}")

    self.parse(resp.body)
  end

  def artifact_first
    @artifact_first ||= attributes["artifact"] ? Artifact.parse(attributes["artifact"].first) : []
  end

  def artifacts
    @artifacts ||= if_enum(attributes["artifact"]).map do |a|
      Artifact.parse(a)
    end
  end

  def cve_id
    cve.try(:first).try(:[], "cve-id")
  end

  def cve_url
    cve.try(:first).try(:[], "url")
  end

  def osvdb_id
    osvdb.try(:first).try(:[], "osvdb-id")
  end

  def osvdb_url
    osvdb.try(:first).try(:[], "url")
  end


  def criticality_name
    criticality.try(:split, "/").try(:last)
  end

  def remaining_versions
    @otp ||= (patched_versions - upgrade_to)
  end
end
