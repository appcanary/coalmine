class Vulnerability < CanaryBase
  
  attr_params :description, :osvdb, :reported_at, :cve, :title, :id, :artifact, :uuid, :versions, :unaffected_versions, :patched_versions, :criticality, :upgrade_to
  attr_enforce_collection :patched_versions, :unaffected_versions

  has_many Artifact, "artifact"
  
  delegate :first, :to => :artifact, :prefix => true
  delegate :name, :to => :artifact_first, :prefix => true
  delegate :kind, :to => :artifact_first
  delegate :kind_pretty, :to => :artifact_first



  def self.find(id)
    self.client.vulnerability(id)
  end

  def to_param
    uuid
  end

  def cve_id
    cve.try(:first).try(:[], "cve-id")
  end

  def cve_url
    cve.try(:first).try(:[], "url")
  end

  def osvdb_id
    osvdb.try(:first).try(:[], "osvdb-id")
  end

  def osvdb_url
    osvdb.try(:first).try(:[], "url")
  end


  def criticality_name
    criticality.try(:split, "/").try(:last)
  end

  def remaining_versions
    @otp ||= (patched_versions - upgrade_to)
  end
end
