# == Schema Information
#
# Table name: log_bundle_vulnerabilities
#
#  id                    :integer          not null, primary key
#  bundle_id             :integer
#  package_id            :integer
#  bundled_package_id    :integer
#  vulnerability_id      :integer
#  vulnerable_package_id :integer
#  created_at            :datetime         not null
#  updated_at            :datetime         not null
#

class LogBundleVulnerability < ActiveRecord::Base
  belongs_to :bundle
  belongs_to :package
  belongs_to :bundled_package
  belongs_to :vulnerability
  belongs_to :vulnerable_package

  # Every time a bundle is changed, note whether 
  # the bundle is vulnerable at that point in time.
  #
  # We create a log instance whenever: 
  # 1. A bundle gets created w/vuln packages
  # 2. Vulnerability that affects a package in bundle gets created
  # 3. A package that is vulnerable gets added to the bundle.

  # TODO lol optimize
  def self.record_vulnerability!(vuln_id)
    bundled_packages = BundledPackage.select_log_join_vulns.
      where('"vulnerable_packages".vulnerability_id = ?', vuln_id)

    bundled_packages.each do |bun|
      self.create(:bundle_id => bun.bundle_id,
                  :package_id => bun.package_id,
                  :bundled_package_id => bun.bundled_package_id,
                  :vulnerability_id => vuln_id,
                  :vulnerable_package_id => bun.vulnerable_package_id)
    end
  end

  # TODO lol optimize
  def self.record_bundle_vulnerabilities!(bundle_id)
    # get all the bundled packages that have vulnerabilities
    # for a given bundle.
    bundled_packages = BundledPackage.select_log_join_vulns.
     where(:bundle_id => bundle_id).
     where('NOT EXISTS 
           (SELECT 1 FROM "log_bundle_vulnerabilities" lbv 
           WHERE lbv.bundle_id = "bundled_packages".bundle_id AND 
                 lbv.package_id = "bundled_packages".package_id AND 
                 lbv.bundled_package_id = "bundled_packages".id AND 
                 lbv.vulnerability_id = "vulnerable_packages".vulnerability_id AND 
                 lbv.vulnerable_package_id = "vulnerable_packages".id)')

     bundled_packages.each do |bun|
       self.create(:bundle_id => bun.bundle_id,
                   :package_id => bun.package_id,
                   :bundled_package_id => bun.bundled_package_id,
                   :vulnerability_id => bun.vulnerability_id,
                   :vulnerable_package_id => bun.vulnerable_package_id)
     end
  end

end
