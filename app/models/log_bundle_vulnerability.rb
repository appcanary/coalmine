# == Schema Information
#
# Table name: log_bundle_vulnerabilities
#
#  id                    :integer          not null, primary key
#  bundle_id             :integer
#  package_id            :integer
#  vulnerability_id      :integer
#  vulnerable_package_id :integer
#  created_at            :datetime         not null
#  updated_at            :datetime         not null
#

class LogBundleVulnerability < ActiveRecord::Base
  belongs_to :bundle
  belongs_to :vulnerable_package

  def self.record_vulnerability!(vuln)
    bundles = BundledPackage.where('"bundled_packages".package_id in (select "vulnerable_packages".package_id  from "vulnerable_packages" where "vulnerable_packages".vulnerability_id = ?)', vuln.id).pluck("bundle_id, package_id")

    bundles.each do |bid, pid|
      self.create(:bundle_id => bid,
                  :package_id => pid,
                  :vulnerability_id => vuln.id)
    end
  end
end
