# == Schema Information
#
# Table name: log_bundle_vulnerabilities
#
#  id                    :integer          not null, primary key
#  bundle_id             :integer
#  package_id            :integer
#  vulnerability_id      :integer
#  vulnerable_package_id :integer
#  created_at            :datetime         not null
#  updated_at            :datetime         not null
#

class LogBundleVulnerability < ActiveRecord::Base
  belongs_to :bundle
  belongs_to :vulnerable_package

  # TODO lol optimize
  def self.record_vulnerability!(vuln)
    bundles = BundledPackage.select('bundle_id, "bundled_packages".package_id, "vulnerable_packages".id vulnerable_package_id').joins('inner join "vulnerable_packages" on "vulnerable_packages".package_id = "bundled_packages".package_id').where('"vulnerable_packages".vulnerability_id = ?', vuln.id)

    bundles.each do |bun|
      self.create(:bundle_id => bun.bundle_id,
                  :package_id => bun.package_id,
                  :vulnerability_id => vuln.id,
                  :vulnerable_package_id => bun.vulnerable_package_id)
    end
  end
end
