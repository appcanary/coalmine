# == Schema Information
#
# Table name: log_bundle_vulnerabilities
#
#  id                    :integer          not null, primary key
#  bundle_id             :integer
#  package_id            :integer
#  bundled_package_id    :integer
#  vulnerability_id      :integer
#  vulnerable_package_id :integer
#  created_at            :datetime         not null
#  updated_at            :datetime         not null
#

class LogBundleVulnerability < ActiveRecord::Base
  belongs_to :bundle
  belongs_to :package
  belongs_to :bundled_package
  belongs_to :vulnerability
  belongs_to :vulnerable_package

  # We create a log instance whenever: 
  # 1. A bundle gets created w/vuln packages
  # 2. Vulnerability that affects a package in bundle gets created
  # 3. A package that is vulnerable gets added to the bundle.

  # TODO lol optimize
  def self.record_vulnerability!(vuln_id)
    bundled_packages = BundledPackage.select('"bundled_packages".id, bundle_id, "bundled_packages".package_id, "vulnerable_packages".id vulnerable_package_id').joins('inner join "vulnerable_packages" on "vulnerable_packages".package_id = "bundled_packages".package_id').where('"vulnerable_packages".vulnerability_id = ?', vuln_id)

    bundled_packages.each do |bun|
      self.create(:bundle_id => bun.bundle_id,
                  :package_id => bun.package_id,
                  :bundled_package_id => bun.id,
                  :vulnerability_id => vuln_id,
                  :vulnerable_package_id => bun.vulnerable_package_id)
    end
  end

  def self.record_vulnerable_bundle!(bundle_id)
    # get all the bundled packages that have vulnerabilities
    # for a given bundle.
    bundled_packages = BundledPackage.select('"bundled_packages".id, bundle_id, "bundled_packages".package_id, "vulnerable_packages".id vulnerable_package_id, "vulnerable_packages".vulnerability_id').joins('inner join "vulnerable_packages" on "vulnerable_packages".package_id = "bundled_packages".package_id').where(:bundle_id => bundle_id)

    bundled_packages.each do |bun|
      begin
      self.create(:bundle_id => bun.bundle_id,
                  :package_id => bun.package_id,
                  :bundled_package_id => bun.id,
                  :vulnerability_id => bun.vulnerability_id,
                  :vulnerable_package_id => bun.vulnerable_package_id)
      rescue ActiveRecord::RecordNotUnique => e
        # this is fine, everything is fine
        # we COULD look inside this table OR we could
        # just have the index fail for us
        # when we try to insert the exact same observation
      end
    end
  end

end
